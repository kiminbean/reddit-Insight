{% if error %}
<!-- Error State -->
<div class="rounded-lg bg-red-50 dark:bg-red-900/30 p-4 border border-red-200 dark:border-red-800">
    <div class="flex">
        <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
            </svg>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800 dark:text-red-200">
                Comparison Failed
            </h3>
            <p class="mt-1 text-sm text-red-700 dark:text-red-300">
                {{ error }}
            </p>
        </div>
    </div>
</div>
{% elif result %}
<!-- Success State -->
<div class="space-y-6">
    <!-- Summary Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
            <svg class="h-5 w-5 mr-2 text-primary-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
            </svg>
            Comparison Results
        </h2>
        <p class="text-sm text-gray-600 dark:text-gray-400">
            Comparing {{ subreddits | length }} subreddits:
            {% for sub in subreddits %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-primary-100 dark:bg-primary-900/50 text-primary-800 dark:text-primary-200">
                r/{{ sub }}
            </span>{% if not loop.last %} {% endif %}
            {% endfor %}
        </p>
    </div>

    <!-- Metrics Comparison Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Metrics Overview</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Subreddit</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Posts</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Avg Score</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Top Keywords</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Sentiment</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for metrics in result.metrics %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                            r/{{ metrics.subreddit }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {{ metrics.post_count }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {{ metrics.avg_score | round(1) }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                            <div class="flex flex-wrap gap-1">
                                {% for kw in metrics.top_keywords[:5] %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                                    {{ kw }}
                                </span>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <div class="flex items-center space-x-2">
                                <span class="text-green-600 dark:text-green-400">{{ (metrics.sentiment.positive * 100) | round(0) }}%</span>
                                <span class="text-gray-400">|</span>
                                <span class="text-gray-600 dark:text-gray-400">{{ (metrics.sentiment.neutral * 100) | round(0) }}%</span>
                                <span class="text-gray-400">|</span>
                                <span class="text-red-600 dark:text-red-400">{{ (metrics.sentiment.negative * 100) | round(0) }}%</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Activity Comparison Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Post Activity</h3>
            <div class="h-64">
                <canvas id="activity-chart"></canvas>
            </div>
        </div>

        <!-- Sentiment Comparison Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Sentiment Distribution</h3>
            <div class="h-64">
                <canvas id="sentiment-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Keywords Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Common Keywords -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
                <svg class="h-5 w-5 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Common Keywords
            </h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                Keywords that appear in multiple subreddits:
            </p>
            {% if result.common_keywords %}
            <div class="flex flex-wrap gap-2">
                {% for kw in result.common_keywords %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200">
                    {{ kw }}
                </span>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-sm text-gray-500 dark:text-gray-400 italic">No common keywords found.</p>
            {% endif %}
        </div>

        <!-- Unique Keywords by Subreddit -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
                <svg class="h-5 w-5 mr-2 text-purple-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
                </svg>
                Unique Keywords
            </h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                Keywords unique to each subreddit:
            </p>
            <div class="space-y-3">
                {% for sub, keywords in result.unique_keywords.items() %}
                <div>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">r/{{ sub }}:</span>
                    {% if keywords %}
                    <div class="flex flex-wrap gap-1 mt-1">
                        {% for kw in keywords[:5] %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-200">
                            {{ kw }}
                        </span>
                        {% endfor %}
                        {% if keywords | length > 5 %}
                        <span class="text-xs text-gray-500 dark:text-gray-400">+{{ keywords | length - 5 }} more</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <span class="text-sm text-gray-500 dark:text-gray-400 italic">No unique keywords</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Similarity Heatmap -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
            <svg class="h-5 w-5 mr-2 text-amber-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
            </svg>
            Keyword Similarity Matrix
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Jaccard similarity between subreddit keyword sets (higher = more similar):
        </p>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr>
                        <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 dark:text-gray-400"></th>
                        {% for sub in result.subreddits %}
                        <th class="px-4 py-2 text-center text-sm font-medium text-gray-900 dark:text-white">r/{{ sub }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for i, row in result.overlap_matrix | list %}
                    <tr>
                        <td class="px-4 py-2 text-sm font-medium text-gray-900 dark:text-white">r/{{ result.subreddits[loop.index0] }}</td>
                        {% for j, value in row | list %}
                        <td class="px-4 py-2 text-center">
                            <span class="inline-flex items-center justify-center w-12 h-8 rounded text-sm font-medium
                                {% if value >= 0.7 %}
                                bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200
                                {% elif value >= 0.4 %}
                                bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-200
                                {% elif value >= 0.2 %}
                                bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-200
                                {% else %}
                                bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200
                                {% endif %}
                            ">
                                {{ (value * 100) | round(0) }}%
                            </span>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Initialize charts with the data from the result
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
    });
    // Also reinitialize on HTMX swap
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'comparison-results') {
            initCharts();
        }
    });

    function initCharts() {
        const chartData = {{ result.chart_data | tojson | safe }};

        if (!chartData || Object.keys(chartData).length === 0) return;

        // Activity Chart
        const activityCtx = document.getElementById('activity-chart');
        if (activityCtx && chartData.activity) {
            new Chart(activityCtx, chartData.activity);
        }

        // Sentiment Chart
        const sentimentCtx = document.getElementById('sentiment-chart');
        if (sentimentCtx && chartData.sentiment) {
            new Chart(sentimentCtx, chartData.sentiment);
        }
    }
</script>
{% endif %}
