{# Chart Configuration Component

   Provides color-blind friendly chart defaults and helper macros.
   Uses ColorBrewer palettes optimized for accessibility (WCAG 2.1 AA compliant).
#}

{# Color-blind friendly palette (8 colors) #}
{% set chart_colors = [
    '#1f77b4',
    '#ff7f0e',
    '#2ca02c',
    '#d62728',
    '#9467bd',
    '#8c564b',
    '#e377c2',
    '#7f7f7f'
] %}

{# Get color by index (cycles through palette) #}
{% macro get_chart_color(index) %}
{{ chart_colors[index % chart_colors|length] }}
{% endmacro %}

{# Generate inline script for accessible chart #}
{% macro chart_init_script(canvas_id, chart_type, data_url, options_json='{}') %}
<script>
(function() {
    var canvas = document.getElementById('{{ canvas_id }}');
    if (!canvas) return;

    fetch('{{ data_url }}')
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.error) {
                console.error('Chart data error:', data.error);
                return;
            }

            var options = {{ options_json | safe }};

            // Merge with accessible defaults
            if (typeof ChartUtils !== 'undefined') {
                var isDark = document.documentElement.classList.contains('dark');
                var defaults = ChartUtils.getChartDefaults(isDark);
                options = Object.assign({}, defaults, options);
            }

            new Chart(canvas.getContext('2d'), {
                type: '{{ chart_type }}',
                data: data,
                options: options
            });
        })
        .catch(function(error) {
            console.error('Failed to load chart data:', error);
        });
})();
</script>
{% endmacro %}

{# Chart container with accessible wrapper #}
{% macro chart_container(canvas_id, title, description='', height='300px', extra_classes='') %}
<div class="chart-container {{ extra_classes }}" style="position: relative; height: {{ height }};">
    {% if title %}
    <h4 class="sr-only">{{ title }}</h4>
    {% endif %}
    <canvas id="{{ canvas_id }}"
            role="img"
            aria-label="{{ title or 'Data visualization chart' }}"
            {% if description %}aria-describedby="{{ canvas_id }}-desc"{% endif %}></canvas>
    {% if description %}
    <div id="{{ canvas_id }}-desc" class="sr-only">{{ description }}</div>
    {% endif %}
</div>
{% endmacro %}

{# Legend with patterns for additional accessibility #}
{% macro chart_legend_with_patterns(items) %}
<div class="flex flex-wrap gap-4 mt-4 justify-center" role="list" aria-label="Chart legend">
    {% for item in items %}
    <div class="flex items-center gap-2" role="listitem">
        {# Color swatch with pattern for colorblind support #}
        <span class="inline-block w-4 h-4 rounded"
              style="background-color: {{ item.color }}; {% if item.pattern %}background-image: {{ item.pattern }}{% endif %}"
              aria-hidden="true"></span>
        <span class="text-sm text-gray-600 dark:text-gray-400">{{ item.label }}</span>
    </div>
    {% endfor %}
</div>
{% endmacro %}

{# Color contrast helper - returns text color (black/white) based on background #}
{% macro contrast_text_color(bg_color) %}
{# Simple luminance calculation #}
{% set r = bg_color[1:3] | int(base=16) %}
{% set g = bg_color[3:5] | int(base=16) %}
{% set b = bg_color[5:7] | int(base=16) %}
{% set luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255 %}
{% if luminance > 0.5 %}#000000{% else %}#ffffff{% endif %}
{% endmacro %}
