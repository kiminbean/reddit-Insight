<!-- Prediction Chart Partial - HTMX로 동적 로드 가능 -->
<div class="bg-white rounded-lg shadow p-6" id="prediction-container">
    <div class="flex justify-between items-center mb-4">
        <div>
            <h3 class="text-lg font-semibold text-gray-900">
                Trend Prediction: {{ keyword }}
            </h3>
            <p class="text-sm text-gray-500">
                {{ forecast_days }}-day forecast with {{ prediction.confidence_percent }}% confidence interval
            </p>
        </div>
        <div class="flex items-center space-x-2">
            <!-- Model Info Badge -->
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                {{ prediction.model_name }}
            </span>
            <!-- Close Button -->
            <button onclick="closePredictionChart()"
                    class="text-gray-400 hover:text-gray-500 focus:outline-none"
                    title="Close">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="grid grid-cols-3 gap-4 mb-4">
        <div class="bg-gray-50 rounded-lg p-3 text-center">
            <div class="text-xs font-medium text-gray-500 uppercase">MAE</div>
            <div class="text-lg font-semibold text-gray-900">{{ "%.2f"|format(prediction.mae) }}</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-3 text-center">
            <div class="text-xs font-medium text-gray-500 uppercase">RMSE</div>
            <div class="text-lg font-semibold text-gray-900">{{ "%.2f"|format(prediction.rmse) }}</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-3 text-center">
            <div class="text-xs font-medium text-gray-500 uppercase">MAPE</div>
            <div class="text-lg font-semibold text-gray-900">{{ "%.1f"|format(prediction.mape) }}%</div>
        </div>
    </div>

    <!-- Forecast Period Selector -->
    <div class="mb-4">
        <label for="forecast-days" class="block text-sm font-medium text-gray-700 mb-1">
            Forecast Period
        </label>
        <select id="forecast-days"
                class="block w-full sm:w-32 rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border"
                hx-get="/dashboard/trends/predict-partial/{{ keyword }}"
                hx-target="#prediction-section"
                hx-swap="innerHTML"
                hx-include="[name='forecast-days']"
                name="days">
            <option value="3" {% if forecast_days == 3 %}selected{% endif %}>3 days</option>
            <option value="7" {% if forecast_days == 7 %}selected{% endif %}>7 days</option>
            <option value="14" {% if forecast_days == 14 %}selected{% endif %}>14 days</option>
        </select>
    </div>

    <!-- Chart Container -->
    <div class="h-80">
        <canvas id="predictionChart-{{ keyword | replace(' ', '-') }}"></canvas>
    </div>

    <!-- Legend -->
    <div class="mt-4 flex flex-wrap justify-center gap-4 text-xs text-gray-600">
        <div class="flex items-center">
            <span class="inline-block w-4 h-0.5 bg-blue-500 mr-2"></span>
            Historical Data
        </div>
        <div class="flex items-center">
            <span class="inline-block w-4 h-0.5 bg-green-500 mr-2 border-dashed" style="border-top: 2px dashed rgb(34, 197, 94);"></span>
            Forecast
        </div>
        <div class="flex items-center">
            <span class="inline-block w-4 h-3 bg-green-100 mr-2 opacity-50"></span>
            {{ prediction.confidence_percent }}% Confidence Interval
        </div>
    </div>
</div>

<script>
(function() {
    // 기존 차트가 있으면 제거
    const chartId = 'predictionChart-{{ keyword | replace(" ", "-") }}';
    const existingChart = Chart.getChart(chartId);
    if (existingChart) {
        existingChart.destroy();
    }

    const ctx = document.getElementById(chartId).getContext('2d');

    // 예측 데이터를 Chart.js 형식으로 준비
    const chartData = {
        labels: {{ prediction.historical_dates + prediction.forecast_dates | tojson }},
        datasets: [
            {
                label: '{{ keyword }} (Historical)',
                data: {{ (prediction.historical_values + [None] * (prediction.forecast_dates | length)) | tojson }}.map(v => v === null ? null : v),
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: false,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 5,
            },
            {
                label: '{{ keyword }} (Forecast)',
                data: [
                    {% for _ in range(prediction.historical_values | length - 1) %}null, {% endfor %}
                    {{ prediction.historical_values[-1] if prediction.historical_values else 'null' }},
                    {% for v in prediction.forecast_values %}{{ v }}{% if not loop.last %}, {% endif %}{% endfor %}
                ],
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                borderDash: [5, 5],
                fill: false,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 5,
            },
            {
                label: '{{ prediction.confidence_percent }}% CI Lower',
                data: [
                    {% for _ in range(prediction.historical_values | length - 1) %}null, {% endfor %}
                    {{ prediction.historical_values[-1] if prediction.historical_values else 'null' }},
                    {% for v in prediction.confidence_lower %}{{ v }}{% if not loop.last %}, {% endif %}{% endfor %}
                ],
                borderColor: 'rgba(34, 197, 94, 0.3)',
                backgroundColor: 'transparent',
                borderDash: [2, 2],
                fill: false,
                tension: 0.3,
                pointRadius: 0,
            },
            {
                label: '{{ prediction.confidence_percent }}% CI Upper',
                data: [
                    {% for _ in range(prediction.historical_values | length - 1) %}null, {% endfor %}
                    {{ prediction.historical_values[-1] if prediction.historical_values else 'null' }},
                    {% for v in prediction.confidence_upper %}{{ v }}{% if not loop.last %}, {% endif %}{% endfor %}
                ],
                borderColor: 'rgba(34, 197, 94, 0.3)',
                backgroundColor: 'rgba(34, 197, 94, 0.15)',
                borderDash: [2, 2],
                fill: '-1',
                tension: 0.3,
                pointRadius: 0,
            }
        ]
    };

    new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(1);
                            }
                            return label;
                        }
                    }
                },
                annotation: {
                    annotations: {
                        forecastLine: {
                            type: 'line',
                            xMin: {{ prediction.historical_dates | length - 1 }},
                            xMax: {{ prediction.historical_dates | length - 1 }},
                            borderColor: 'rgba(156, 163, 175, 0.5)',
                            borderWidth: 2,
                            borderDash: [6, 6],
                            label: {
                                display: true,
                                content: 'Forecast Start',
                                position: 'start'
                            }
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    display: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Mentions'
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
})();

// 예측 차트 닫기 함수
function closePredictionChart() {
    const container = document.getElementById('prediction-section');
    if (container) {
        container.innerHTML = '';
        container.classList.add('hidden');
    }
}
</script>
