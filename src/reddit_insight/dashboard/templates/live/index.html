{% extends "base.html" %}

{% block title %}Live Monitoring{% endblock %}

{% block page_title_display %}
Live Monitoring
<span class="ml-3 inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300" id="connection-status">
    Disconnected
</span>
{% endblock %}

{% block content %}
<div class="px-4 sm:px-0 space-y-6">
    <!-- Control Panel -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Monitor Settings</h2>

        <div class="flex flex-col sm:flex-row gap-4">
            <!-- Subreddit Input -->
            <div class="flex-1">
                <label for="subreddit-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Subreddit
                </label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500 dark:text-gray-400">r/</span>
                    <input type="text"
                           id="subreddit-input"
                           placeholder="python"
                           value="{{ initial_subreddit or '' }}"
                           class="block w-full pl-8 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex items-end gap-2">
                <button id="btn-connect"
                        onclick="liveDashboard.connect()"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                    <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M13 12a1 1 0 11-2 0 1 1 0 012 0z" />
                    </svg>
                    Connect
                </button>
                <button id="btn-disconnect"
                        onclick="liveDashboard.disconnect()"
                        disabled
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Disconnect
                </button>
            </div>
        </div>

        <!-- Active Monitors -->
        {% if active_monitors %}
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Active monitors:</p>
            <div class="flex flex-wrap gap-2">
                {% for sub in active_monitors %}
                <button onclick="document.getElementById('subreddit-input').value='{{ sub }}'; liveDashboard.connect();"
                        class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary-100 text-primary-700 dark:bg-primary-900 dark:text-primary-300 hover:bg-primary-200 dark:hover:bg-primary-800 transition-colors">
                    r/{{ sub }}
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Alert Banner -->
    <div id="alert-banner" class="hidden bg-yellow-50 dark:bg-yellow-900/50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700 dark:text-yellow-300" id="alert-message"></p>
            </div>
            <div class="ml-auto pl-3">
                <button onclick="document.getElementById('alert-banner').classList.add('hidden')" class="text-yellow-500 hover:text-yellow-600">
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Live Feed (2/3 width) -->
        <div class="lg:col-span-2">
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                        Live Feed
                        <span id="feed-count" class="ml-2 text-sm font-normal text-gray-500 dark:text-gray-400">(0 posts)</span>
                    </h3>
                    <button onclick="liveDashboard.clearFeed()"
                            class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        Clear
                    </button>
                </div>
                <div id="live-feed" class="divide-y divide-gray-200 dark:divide-gray-700 max-h-[600px] overflow-y-auto">
                    <!-- Feed items will be inserted here -->
                    <div class="p-8 text-center text-gray-500 dark:text-gray-400" id="feed-placeholder">
                        <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.348 14.651a3.75 3.75 0 010-5.303m5.304 0a3.75 3.75 0 010 5.303m-7.425 2.122a6.75 6.75 0 010-9.546m9.546 0a6.75 6.75 0 010 9.546M5.106 18.894c-3.808-3.808-3.808-9.98 0-13.789m13.788 0c3.808 3.808 3.808 9.981 0 13.79M12 12h.008v.007H12V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                        </svg>
                        <p class="mt-2 text-sm">Connect to a subreddit to see live posts</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Panel (1/3 width) -->
        <div class="space-y-6">
            <!-- Activity Stats -->
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Activity</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500 dark:text-gray-400">Posts this session</span>
                            <span class="font-medium text-gray-900 dark:text-white" id="stat-posts">0</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500 dark:text-gray-400">Spikes detected</span>
                            <span class="font-medium text-gray-900 dark:text-white" id="stat-spikes">0</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500 dark:text-gray-400">Connection time</span>
                            <span class="font-medium text-gray-900 dark:text-white" id="stat-time">--:--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Chart -->
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Activity Rate</h3>
                <div class="h-48">
                    <canvas id="activity-chart"></canvas>
                </div>
            </div>

            <!-- Recent Activity Log -->
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Event Log</h3>
                <div id="event-log" class="space-y-2 max-h-48 overflow-y-auto text-sm">
                    <p class="text-gray-500 dark:text-gray-400 text-center py-4">No events yet</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/live-dashboard.js"></script>
<script>
    // Initialize with initial subreddit if provided
    const initialSubreddit = '{{ initial_subreddit or "" }}';

    document.addEventListener('DOMContentLoaded', function() {
        liveDashboard.init();

        if (initialSubreddit) {
            document.getElementById('subreddit-input').value = initialSubreddit;
            liveDashboard.connect();
        }
    });

    // Allow Enter key to connect
    document.getElementById('subreddit-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            liveDashboard.connect();
        }
    });
</script>
{% endblock %}
