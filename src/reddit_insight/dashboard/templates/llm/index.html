{% extends "base.html" %}

{% block title %}AI Analysis{% endblock %}

{% block content %}
<div class="px-4 sm:px-0">
    <!-- API Configuration Warning -->
    {% if not is_configured %}
    <div class="mb-6 rounded-lg bg-yellow-50 dark:bg-yellow-900/30 p-4 border border-yellow-200 dark:border-yellow-800">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">
                    LLM API Not Configured
                </h3>
                <div class="mt-2 text-sm text-yellow-700 dark:text-yellow-300">
                    <p>
                        AI analysis features require an API key. Set one of these environment variables:
                    </p>
                    <ul class="list-disc list-inside mt-1">
                        <li><code class="bg-yellow-100 dark:bg-yellow-800 px-1 rounded">REDDIT_INSIGHT_ANTHROPIC_API_KEY</code> for Claude</li>
                        <li><code class="bg-yellow-100 dark:bg-yellow-800 px-1 rounded">REDDIT_INSIGHT_OPENAI_API_KEY</code> for OpenAI</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- AI Summary Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <svg class="h-5 w-5 mr-2 text-primary-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
                AI Summary
            </h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Get an AI-powered summary of recent discussions in a subreddit.
            </p>

            <!-- Subreddit Selection -->
            <form id="summary-form" class="space-y-4">
                <div>
                    <label for="summary-subreddit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Select Subreddit
                    </label>
                    <select id="summary-subreddit"
                            name="subreddit"
                            class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                            {% if not is_configured %}disabled{% endif %}>
                        <option value="">Select a subreddit...</option>
                        {% for analysis in recent_analyses %}
                        <option value="{{ analysis.subreddit }}">r/{{ analysis.subreddit }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="button"
                        id="generate-summary-btn"
                        class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
                        {% if not is_configured %}disabled{% endif %}>
                    <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" />
                    </svg>
                    Generate Summary
                </button>
            </form>

            <!-- Summary Result Container -->
            <div id="summary-result" class="mt-4"></div>
        </div>

        <!-- AI Insights Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <svg class="h-5 w-5 mr-2 text-primary-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
                </svg>
                AI Insights
            </h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Generate actionable business insights from analysis data.
            </p>

            <!-- Insights Form -->
            <form id="insights-form" class="space-y-4">
                <div>
                    <label for="insights-subreddit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Select Subreddit
                    </label>
                    <select id="insights-subreddit"
                            name="subreddit"
                            class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                            {% if not is_configured %}disabled{% endif %}>
                        <option value="">Select a subreddit...</option>
                        {% for analysis in recent_analyses %}
                        <option value="{{ analysis.subreddit }}">r/{{ analysis.subreddit }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="button"
                        id="generate-insights-btn"
                        class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
                        {% if not is_configured %}disabled{% endif %}>
                    <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" />
                    </svg>
                    Generate Insights
                </button>
            </form>

            <!-- Insights Result Container -->
            <div id="insights-result" class="mt-4"></div>
        </div>

        <!-- Categorization Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <svg class="h-5 w-5 mr-2 text-primary-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" />
                </svg>
                AI Categorization
            </h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Automatically classify text into predefined categories.
            </p>

            <form id="categorize-form"
                  hx-post="/dashboard/llm/categorize"
                  hx-target="#categorize-result"
                  hx-indicator="#categorize-loading"
                  class="space-y-4">
                <div>
                    <label for="categorize-text" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Text to Categorize
                    </label>
                    <textarea id="categorize-text"
                              name="text"
                              rows="4"
                              class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                              placeholder="Enter text to categorize..."
                              {% if not is_configured %}disabled{% endif %}></textarea>
                </div>
                <div>
                    <label for="categories" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Categories (optional, comma-separated)
                    </label>
                    <input type="text"
                           id="categories"
                           name="categories"
                           class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                           placeholder="Feature Request, Bug Report, Question, ..."
                           value="{{ default_categories | join(', ') }}"
                           {% if not is_configured %}disabled{% endif %}>
                </div>
                <button type="submit"
                        class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
                        {% if not is_configured %}disabled{% endif %}>
                    <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
                    </svg>
                    Categorize
                </button>
            </form>

            <!-- Loading indicator -->
            <div id="categorize-loading" class="htmx-indicator mt-4 text-center">
                <div class="animate-spin inline-block w-6 h-6 border-2 border-primary-500 border-t-transparent rounded-full"></div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Analyzing...</p>
            </div>

            <!-- Category Result Container -->
            <div id="categorize-result" class="mt-4"></div>
        </div>

        <!-- Sentiment Analysis Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <svg class="h-5 w-5 mr-2 text-primary-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 01-6.364 0M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" />
                </svg>
                Deep Sentiment Analysis
            </h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Analyze emotions, aspects, and pain points in text.
            </p>

            <form id="sentiment-form"
                  hx-post="/dashboard/llm/sentiment"
                  hx-target="#sentiment-result"
                  hx-indicator="#sentiment-loading"
                  class="space-y-4">
                <div>
                    <label for="sentiment-text" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Text to Analyze
                    </label>
                    <textarea id="sentiment-text"
                              name="text"
                              rows="4"
                              class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                              placeholder="Enter text for sentiment analysis..."
                              {% if not is_configured %}disabled{% endif %}></textarea>
                </div>
                <button type="submit"
                        class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
                        {% if not is_configured %}disabled{% endif %}>
                    <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 01-6.364 0M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Analyze Sentiment
                </button>
            </form>

            <!-- Loading indicator -->
            <div id="sentiment-loading" class="htmx-indicator mt-4 text-center">
                <div class="animate-spin inline-block w-6 h-6 border-2 border-primary-500 border-t-transparent rounded-full"></div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Analyzing...</p>
            </div>

            <!-- Sentiment Result Container -->
            <div id="sentiment-result" class="mt-4"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Summary generation
        const summaryBtn = document.getElementById('generate-summary-btn');
        const summarySelect = document.getElementById('summary-subreddit');
        const summaryResult = document.getElementById('summary-result');

        if (summaryBtn) {
            summaryBtn.addEventListener('click', async function() {
                const subreddit = summarySelect.value;
                if (!subreddit) {
                    alert('Please select a subreddit');
                    return;
                }

                // Show loading state
                summaryBtn.disabled = true;
                summaryResult.innerHTML = `
                    <div class="text-center py-4">
                        <div class="animate-spin inline-block w-6 h-6 border-2 border-primary-500 border-t-transparent rounded-full"></div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Generating summary...</p>
                    </div>
                `;

                try {
                    const response = await fetch(`/dashboard/llm/summary?subreddit=${encodeURIComponent(subreddit)}`);
                    const html = await response.text();
                    summaryResult.innerHTML = html;
                } catch (error) {
                    summaryResult.innerHTML = `
                        <div class="rounded-md bg-red-50 dark:bg-red-900/30 p-4">
                            <p class="text-sm text-red-700 dark:text-red-300">Error: ${error.message}</p>
                        </div>
                    `;
                } finally {
                    summaryBtn.disabled = false;
                }
            });
        }

        // Insights generation
        const insightsBtn = document.getElementById('generate-insights-btn');
        const insightsSelect = document.getElementById('insights-subreddit');
        const insightsResult = document.getElementById('insights-result');

        if (insightsBtn) {
            insightsBtn.addEventListener('click', async function() {
                const subreddit = insightsSelect.value;
                if (!subreddit) {
                    alert('Please select a subreddit');
                    return;
                }

                // Show loading state
                insightsBtn.disabled = true;
                insightsResult.innerHTML = `
                    <div class="text-center py-4">
                        <div class="animate-spin inline-block w-6 h-6 border-2 border-primary-500 border-t-transparent rounded-full"></div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Generating insights...</p>
                    </div>
                `;

                try {
                    const response = await fetch(`/dashboard/llm/insights?subreddit=${encodeURIComponent(subreddit)}`);
                    const html = await response.text();
                    insightsResult.innerHTML = html;
                } catch (error) {
                    insightsResult.innerHTML = `
                        <div class="rounded-md bg-red-50 dark:bg-red-900/30 p-4">
                            <p class="text-sm text-red-700 dark:text-red-300">Error: ${error.message}</p>
                        </div>
                    `;
                } finally {
                    insightsBtn.disabled = false;
                }
            });
        }
    });
</script>
{% endblock %}
