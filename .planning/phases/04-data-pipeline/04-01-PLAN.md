---
phase: 04-data-pipeline
plan: 01
type: execute
depends_on: ["02-01", "03-03"]
files_modified: [src/reddit_insight/storage/__init__.py, src/reddit_insight/storage/models.py, src/reddit_insight/storage/database.py, pyproject.toml]
---

<objective>
데이터베이스 스키마 및 ORM 모델을 정의한다.

Purpose: 수집된 Reddit 데이터를 영구 저장하기 위한 데이터베이스 구조 구축
Output: SQLAlchemy ORM 모델, 데이터베이스 연결 관리, 마이그레이션 기반
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior context:**
- config.py에 database_url 설정 (기본: sqlite:///./data/reddit_insight.db)
- Pydantic 모델: Post, Comment, SubredditInfo (reddit/models.py)
- UnifiedDataSource로 데이터 수집 가능

**Tech decisions:**
- SQLAlchemy 2.0+ (async 지원)
- SQLite (로컬 개발), PostgreSQL 호환 설계
- Alembic 마이그레이션 (선택적)

**Constraints:**
- 무료 도구만 사용
- 로컬 개발 환경 우선
</context>

<tasks>

<task type="auto">
  <name>Task 1: 의존성 추가 및 storage 모듈 구조</name>
  <files>pyproject.toml, src/reddit_insight/storage/__init__.py</files>
  <action>
  1. pyproject.toml에 데이터베이스 의존성 추가:
     - "sqlalchemy>=2.0.0" (ORM)
     - "aiosqlite>=0.19.0" (async SQLite)

  2. src/reddit_insight/storage/ 디렉토리 생성

  3. src/reddit_insight/storage/__init__.py 생성:
     - 모듈 레벨 export 정의
     - __all__ = ["Database", "PostModel", "CommentModel", "SubredditModel"]
  </action>
  <verify>
  - cat pyproject.toml | grep -E "sqlalchemy|aiosqlite"
  - ls -la src/reddit_insight/storage/
  </verify>
  <done>
  - sqlalchemy, aiosqlite 의존성 추가됨
  - storage 모듈 디렉토리 구조 생성됨
  </done>
</task>

<task type="auto">
  <name>Task 2: SQLAlchemy ORM 모델 정의</name>
  <files>src/reddit_insight/storage/models.py</files>
  <action>
  src/reddit_insight/storage/models.py 생성:

  1. Base 클래스:
     - DeclarativeBase 상속
     - 공통 컬럼 믹스인 (created_at, updated_at)

  2. SubredditModel:
     - id: int (PK, autoincrement)
     - name: str (unique, indexed)
     - display_name: str
     - title: str | None
     - description: str | None
     - subscribers: int
     - over18: bool
     - reddit_created_utc: datetime
     - fetched_at: datetime
     - posts: relationship -> PostModel

  3. PostModel:
     - id: int (PK, autoincrement)
     - reddit_id: str (unique, indexed) - Reddit의 post ID
     - subreddit_id: int (FK -> SubredditModel)
     - title: str
     - selftext: str | None
     - author: str
     - score: int
     - num_comments: int
     - url: str
     - permalink: str
     - is_self: bool
     - reddit_created_utc: datetime
     - fetched_at: datetime
     - comments: relationship -> CommentModel

  4. CommentModel:
     - id: int (PK, autoincrement)
     - reddit_id: str (unique, indexed)
     - post_id: int (FK -> PostModel)
     - parent_reddit_id: str | None (부모 댓글 ID)
     - body: str
     - author: str
     - score: int
     - reddit_created_utc: datetime
     - fetched_at: datetime

  주의:
  - reddit_id는 Reddit API에서 받은 원본 ID
  - fetched_at은 수집 시점 기록
  - 인덱스: reddit_id, subreddit_id, fetched_at
  </action>
  <verify>
  - python -c "import sys; sys.path.insert(0, 'src'); from reddit_insight.storage.models import PostModel, CommentModel, SubredditModel; print('Models OK')"
  </verify>
  <done>
  - SQLAlchemy ORM 모델 정의됨
  - 관계 설정 완료 (Subreddit -> Posts -> Comments)
  </done>
</task>

<task type="auto">
  <name>Task 3: 데이터베이스 연결 관리</name>
  <files>src/reddit_insight/storage/database.py</files>
  <action>
  src/reddit_insight/storage/database.py 생성:

  1. Database 클래스:
     - __init__(url: str | None = None)
       - url이 없으면 Settings에서 가져옴
     - _engine: AsyncEngine (lazy init)
     - _session_factory: async_sessionmaker

  2. 연결 관리:
     - async connect(): 엔진 생성, 테이블 생성
     - async disconnect(): 엔진 종료
     - async get_session() -> AsyncSession: 세션 반환

  3. 컨텍스트 매니저:
     - async with Database() as db: ...
     - async with db.session() as session: ...

  4. 테이블 관리:
     - async create_tables(): 모든 테이블 생성
     - async drop_tables(): 모든 테이블 삭제 (개발용)

  주의:
  - SQLite는 파일 경로 디렉토리가 없으면 생성
  - echo=True는 debug 모드에서만
  </action>
  <verify>
  - python -c "import sys; sys.path.insert(0, 'src'); from reddit_insight.storage.database import Database; print('Database OK')"
  </verify>
  <done>
  - Database 클래스가 async 연결 관리
  - 세션 팩토리 패턴 구현
  </done>
</task>

<task type="auto">
  <name>Task 4: Pydantic ↔ ORM 변환 및 export</name>
  <files>src/reddit_insight/storage/models.py, src/reddit_insight/storage/__init__.py</files>
  <action>
  1. models.py에 변환 메서드 추가:
     - PostModel.from_pydantic(post: Post, subreddit_id: int) -> PostModel
     - PostModel.to_pydantic() -> Post
     - CommentModel.from_pydantic(comment: Comment, post_id: int) -> CommentModel
     - CommentModel.to_pydantic() -> Comment
     - SubredditModel.from_pydantic(info: SubredditInfo) -> SubredditModel
     - SubredditModel.to_pydantic() -> SubredditInfo

  2. __init__.py 업데이트:
     - Database, PostModel, CommentModel, SubredditModel export
     - __all__ 업데이트
  </action>
  <verify>
  - python -c "import sys; sys.path.insert(0, 'src'); from reddit_insight.storage import Database, PostModel, CommentModel, SubredditModel; print('All exports OK')"
  </verify>
  <done>
  - Pydantic ↔ ORM 변환 지원
  - 패키지 export 완료
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] sqlalchemy, aiosqlite 의존성 추가됨
- [ ] PostModel, CommentModel, SubredditModel 정의됨
- [ ] Database 클래스가 async 연결 관리
- [ ] Pydantic ↔ ORM 변환 동작
</verification>

<success_criteria>

- 모든 태스크 완료
- 데이터베이스 스키마 정의됨
- ORM 모델과 Pydantic 모델 간 변환 가능

</success_criteria>

<output>
After completion, create `.planning/phases/04-data-pipeline/04-01-SUMMARY.md`
</output>
