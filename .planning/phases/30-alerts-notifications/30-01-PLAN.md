---
phase: 30-alerts-notifications
plan: 01
type: execute
depends_on: ["29-01"]
files_modified: [src/reddit_insight/alerts/manager.py, src/reddit_insight/alerts/notifiers.py, src/reddit_insight/dashboard/routers/alerts.py]
---

<objective>
알림 및 알림 시스템을 구현한다: 이메일/웹훅 알림, 임계값 트리거.

Purpose: 중요한 이벤트에 대한 자동 알림으로 사용자의 즉각적인 대응 지원
Output: AlertManager, EmailNotifier, WebhookNotifier, 알림 설정 UI
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/reddit_insight/streaming/monitor.py

**알림 요구사항:**
- 키워드 급등 알림
- 감성 변화 알림
- 활동량 임계값 알림
- 이메일/웹훅 전송
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Alert Manager</name>
  <files>src/reddit_insight/alerts/__init__.py, src/reddit_insight/alerts/manager.py, src/reddit_insight/alerts/rules.py</files>
  <action>알림 관리자를 구현한다:

  ```python
  from enum import Enum
  from dataclasses import dataclass

  class AlertType(Enum):
      KEYWORD_SURGE = "keyword_surge"
      SENTIMENT_SHIFT = "sentiment_shift"
      ACTIVITY_SPIKE = "activity_spike"
      NEW_TRENDING = "new_trending"

  @dataclass
  class AlertRule:
      id: str
      type: AlertType
      subreddit: str
      condition: dict  # {"threshold": 50, "window_minutes": 60}
      notifiers: list[str]  # ["email", "webhook"]
      enabled: bool = True

  @dataclass
  class Alert:
      rule_id: str
      type: AlertType
      message: str
      data: dict
      triggered_at: datetime

  class AlertManager:
      def __init__(self, notifiers: dict[str, Notifier]):
          self._rules: dict[str, AlertRule] = {}
          self._notifiers = notifiers
          self._history: list[Alert] = []

      def add_rule(self, rule: AlertRule) -> None:
          """알림 규칙 추가"""

      def remove_rule(self, rule_id: str) -> None:
          """알림 규칙 제거"""

      def check_rules(self, subreddit: str, metrics: dict) -> list[Alert]:
          """메트릭을 규칙과 비교하여 알림 생성"""

      async def process_alert(self, alert: Alert) -> None:
          """알림 처리 및 알림 전송"""

      def get_history(self, limit: int = 100) -> list[Alert]:
          """최근 알림 이력"""
  ```</action>
  <verify>pytest tests/alerts/test_manager.py -v</verify>
  <done>AlertManager 구현 완료</done>
</task>

<task type="auto">
  <name>Task 2: Implement Notifiers</name>
  <files>src/reddit_insight/alerts/notifiers.py, src/reddit_insight/config.py</files>
  <action>알림 전송자를 구현한다:

  ```python
  from abc import ABC, abstractmethod
  import smtplib
  import httpx

  class Notifier(ABC):
      @abstractmethod
      async def send(self, alert: Alert) -> bool:
          """알림 전송, 성공 여부 반환"""

  class EmailNotifier(Notifier):
      def __init__(self, smtp_host: str, smtp_port: int,
                   username: str, password: str, from_addr: str):
          self.smtp_host = smtp_host
          self.smtp_port = smtp_port
          self.username = username
          self.password = password
          self.from_addr = from_addr

      async def send(self, alert: Alert, to_addrs: list[str]) -> bool:
          """이메일 알림 전송"""
          subject = f"[Reddit Insight] {alert.type.value}: {alert.message}"
          body = self._format_email_body(alert)
          # smtplib로 전송

  class WebhookNotifier(Notifier):
      def __init__(self, default_url: str | None = None):
          self.default_url = default_url

      async def send(self, alert: Alert, url: str | None = None) -> bool:
          """웹훅 전송 (Slack, Discord, custom 등)"""
          webhook_url = url or self.default_url
          payload = {
              "type": alert.type.value,
              "message": alert.message,
              "data": alert.data,
              "triggered_at": alert.triggered_at.isoformat()
          }
          async with httpx.AsyncClient() as client:
              response = await client.post(webhook_url, json=payload)
              return response.status_code == 200

  class SlackNotifier(WebhookNotifier):
      """Slack 형식 웹훅"""
      def _format_payload(self, alert: Alert) -> dict:
          return {
              "text": f":bell: *{alert.type.value}*\n{alert.message}",
              "attachments": [{"fields": [...]}]
          }
  ```

  설정 추가 (config.py):
  - SMTP_HOST, SMTP_PORT, SMTP_USERNAME, SMTP_PASSWORD
  - ALERT_WEBHOOK_URL
  - ALERT_EMAIL_RECIPIENTS</action>
  <verify>pytest tests/alerts/test_notifiers.py -v (mock SMTP, HTTP 사용)</verify>
  <done>EmailNotifier, WebhookNotifier 구현 완료</done>
</task>

<task type="auto">
  <name>Task 3: Create Alerts Dashboard UI</name>
  <files>src/reddit_insight/dashboard/routers/alerts.py, src/reddit_insight/dashboard/templates/alerts/index.html, src/reddit_insight/dashboard/templates/alerts/partials/rule_form.html</files>
  <action>알림 설정 UI를 구현한다:

  1. 라우터 (alerts.py):
     - GET /dashboard/alerts - 알림 설정 페이지
     - GET /dashboard/alerts/rules - 규칙 목록
     - POST /dashboard/alerts/rules - 규칙 생성
     - PUT /dashboard/alerts/rules/{id} - 규칙 수정
     - DELETE /dashboard/alerts/rules/{id} - 규칙 삭제
     - GET /dashboard/alerts/history - 알림 이력
     - POST /dashboard/alerts/test - 테스트 알림 전송

  2. UI 컴포넌트:
     - 규칙 목록 (활성/비활성 토글)
     - 규칙 생성 폼:
       - 알림 유형 선택
       - 대상 서브레딧
       - 임계값 설정
       - 알림 채널 선택 (이메일, 웹훅)
     - 알림 이력 테이블
     - 테스트 알림 버튼

  3. 네비게이션에 "Alerts" 메뉴 추가

  4. 알림 이력 표시:
     - 시간, 유형, 메시지, 상태 (전송됨/실패)</action>
  <verify>브라우저에서 /dashboard/alerts 작동 확인</verify>
  <done>알림 설정 UI 구현 완료</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] AlertManager 단위 테스트 통과
- [ ] Notifier 단위 테스트 통과 (mock)
- [ ] /dashboard/alerts 페이지 작동
- [ ] 테스트 알림 전송 작동
</verification>

<success_criteria>

- AlertManager: 규칙 관리, 알림 생성
- EmailNotifier, WebhookNotifier 구현
- 알림 설정 UI: 규칙 CRUD, 이력 조회
- 테스트 알림 기능
</success_criteria>

<output>
After completion, create `.planning/phases/30-alerts-notifications/30-01-SUMMARY.md`
</output>
