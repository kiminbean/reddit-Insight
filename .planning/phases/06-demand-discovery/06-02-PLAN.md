---
phase: 06-demand-discovery
plan: 02
type: execute
depends_on: ["06-01"]
files_modified: [src/reddit_insight/analysis/demand_detector.py]
---

<objective>
패턴 매칭 엔진을 구현한다.

Purpose: 텍스트에서 수요 패턴을 자동으로 탐지하고 추출
Output: DemandDetector, 매칭 결과, 컨텍스트 추출
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-demand-discovery/06-01-PLAN.md

**Prior plan context:**
- DemandPattern, DemandMatch 데이터 구조 있음
- DemandPatternLibrary로 패턴 관리
- ENGLISH_PATTERNS 정의됨

**Detection approach:**
- 정규식 기반 1차 필터링 (빠름)
- 컨텍스트 윈도우로 주변 텍스트 추출
- 신뢰도 점수 계산
</context>

<tasks>

<task type="auto">
  <name>Task 1: 패턴 매칭 엔진</name>
  <files>src/reddit_insight/analysis/demand_detector.py</files>
  <action>
  src/reddit_insight/analysis/demand_detector.py 생성:

  1. DemandDetectorConfig 데이터 클래스:
     - context_window: int = 100 (매칭 전후 문자 수)
     - min_confidence: float = 0.5
     - case_sensitive: bool = False
     - languages: list[str] = ["en"]

  2. DemandDetector 클래스:
     - __init__(
         pattern_library: DemandPatternLibrary | None = None,
         config: DemandDetectorConfig | None = None
       )
     - _library: DemandPatternLibrary
     - _config: DemandDetectorConfig

  3. 기본 탐지 메서드:
     - detect(text: str) -> list[DemandMatch]:
       - 텍스트에서 모든 수요 패턴 탐지
       - 중복 제거 (겹치는 매칭)

     - detect_in_post(post: Post) -> list[DemandMatch]:
       - Post의 title + selftext 분석

     - detect_in_posts(posts: list[Post]) -> list[DemandMatch]:
       - 여러 게시물 일괄 분석
  </action>
  <verify>
  - python -c "import sys; sys.path.insert(0, 'src'); from reddit_insight.analysis.demand_detector import DemandDetector; d = DemandDetector(); print('DemandDetector OK')"
  </verify>
  <done>
  - DemandDetector 기본 구조 구현
  - Post 객체 직접 분석 가능
  </done>
</task>

<task type="auto">
  <name>Task 2: 컨텍스트 추출 및 신뢰도</name>
  <files>src/reddit_insight/analysis/demand_detector.py</files>
  <action>
  demand_detector.py에 추가:

  1. 컨텍스트 추출:
     - _extract_context(
         text: str,
         match_start: int,
         match_end: int,
         window: int
       ) -> str:
       - 매칭 전후 window 문자 추출
       - 문장 경계 고려 (마침표, 줄바꿈)

  2. 신뢰도 계산:
     - _calculate_confidence(
         text: str,
         pattern: DemandPattern,
         match: re.Match
       ) -> float:
       - 패턴 가중치 적용
       - 키워드 존재 여부 보너스
       - 문맥 품질 평가

  3. 중복 제거:
     - _deduplicate_matches(
         matches: list[DemandMatch]
       ) -> list[DemandMatch]:
       - 겹치는 매칭 중 높은 신뢰도 선택
       - 같은 span 내 여러 패턴 시 최고 점수 유지

  4. 매칭 실행:
     - _match_pattern(
         text: str,
         pattern: DemandPattern
       ) -> list[DemandMatch]:
       - 단일 패턴 매칭 수행
       - 컨텍스트 및 신뢰도 포함
  </action>
  <verify>
  - python -c "import sys; sys.path.insert(0, 'src'); from reddit_insight.analysis.demand_detector import DemandDetector; d = DemandDetector(); matches = d.detect('I wish there was a better way to organize my notes'); print(f'Found {len(matches)} matches')"
  </verify>
  <done>
  - 컨텍스트 윈도우 추출 구현
  - 신뢰도 점수 계산 로직
  </done>
</task>

<task type="auto">
  <name>Task 3: 카테고리별 분석</name>
  <files>src/reddit_insight/analysis/demand_detector.py</files>
  <action>
  demand_detector.py에 카테고리 분석 추가:

  1. 카테고리별 탐지:
     - detect_by_category(
         text: str,
         category: DemandCategory
       ) -> list[DemandMatch]:
       - 특정 카테고리 패턴만 적용

  2. 카테고리 통계:
     - get_category_stats(
         matches: list[DemandMatch]
       ) -> dict[DemandCategory, int]:
       - 카테고리별 매칭 수 집계

  3. 상위 수요 추출:
     - get_top_demands(
         matches: list[DemandMatch],
         top_n: int = 10
       ) -> list[DemandMatch]:
       - 신뢰도 기준 상위 N개 반환

  4. DemandSummary 데이터 클래스:
     - total_matches: int
     - by_category: dict[DemandCategory, int]
     - top_demands: list[DemandMatch]
     - analyzed_texts: int

  5. 요약 생성:
     - summarize(matches: list[DemandMatch]) -> DemandSummary
  </action>
  <verify>
  - python -c "import sys; sys.path.insert(0, 'src'); from reddit_insight.analysis.demand_detector import DemandDetector, DemandSummary; d = DemandDetector(); print('DemandSummary OK')"
  </verify>
  <done>
  - 카테고리별 분석 기능
  - 수요 요약 리포트 생성
  </done>
</task>

<task type="auto">
  <name>Task 4: export 및 통합</name>
  <files>src/reddit_insight/analysis/__init__.py</files>
  <action>
  1. __init__.py 업데이트:
     - DemandDetector, DemandDetectorConfig export
     - DemandSummary export
     - __all__ 업데이트

  2. 통합 테스트:
     - 샘플 텍스트로 전체 파이프라인 테스트
  </action>
  <verify>
  - python -c "import sys; sys.path.insert(0, 'src'); from reddit_insight.analysis import DemandDetector, DemandSummary, DemandCategory; print('All demand detector exports OK')"
  </verify>
  <done>
  - 수요 탐지 모듈 export됨
  - 통합 동작 확인
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] DemandDetector가 텍스트에서 패턴 탐지
- [ ] 컨텍스트 추출 및 신뢰도 계산 동작
- [ ] 카테고리별 분석 가능
- [ ] DemandSummary 요약 생성
</verification>

<success_criteria>

- 모든 태스크 완료
- 패턴 매칭 엔진 동작
- Post 객체 직접 분석 가능

</success_criteria>

<output>
After completion, create `.planning/phases/06-demand-discovery/06-02-SUMMARY.md`
</output>
