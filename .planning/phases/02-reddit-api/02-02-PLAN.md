---
phase: 02-reddit-api
plan: 02
type: execute
depends_on: ["02-01"]
files_modified: [src/reddit_insight/reddit/client.py, src/reddit_insight/reddit/collectors.py, tests/test_collectors.py]
---

<objective>
Reddit 게시물 및 댓글 수집 기능을 구현한다.

Purpose: Subreddit에서 게시물과 댓글을 체계적으로 수집
Output: PostCollector, CommentCollector 클래스
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-reddit-api/02-01-PLAN.md

**Prior plan context:**
- RedditClient 클래스 구현됨
- Post, Comment Pydantic 모델 정의됨
- PRAW 의존성 추가됨

**API constraints:**
- Rate limit: 60 requests/minute
- 한 번에 최대 100개 항목 조회
- PRAW가 pagination 자동 처리
</context>

<tasks>

<task type="auto">
  <name>Task 1: 게시물 수집기 구현</name>
  <files>src/reddit_insight/reddit/collectors.py</files>
  <action>
  src/reddit_insight/reddit/collectors.py 생성:

  1. PostCollector 클래스:
     - __init__(client: RedditClient)

  2. 수집 메서드:
     - get_hot(subreddit: str, limit: int = 100) -> list[Post]
     - get_new(subreddit: str, limit: int = 100) -> list[Post]
     - get_top(subreddit: str, time_filter: str = "week", limit: int = 100) -> list[Post]
     - get_rising(subreddit: str, limit: int = 100) -> list[Post]

  3. 검색 메서드:
     - search(subreddit: str, query: str, sort: str = "relevance", limit: int = 100) -> list[Post]

  4. 유틸리티:
     - _convert_submission(submission) -> Post: PRAW submission을 Post 모델로 변환

  time_filter 옵션: "hour", "day", "week", "month", "year", "all"
  </action>
  <verify>
  - python -c "import sys; sys.path.insert(0, 'src'); from reddit_insight.reddit.collectors import PostCollector; print('PostCollector OK')"
  </verify>
  <done>
  - PostCollector가 다양한 정렬 방식으로 게시물 수집 가능
  - 검색 기능 구현됨
  </done>
</task>

<task type="auto">
  <name>Task 2: 댓글 수집기 구현</name>
  <files>src/reddit_insight/reddit/collectors.py</files>
  <action>
  collectors.py에 CommentCollector 클래스 추가:

  1. CommentCollector 클래스:
     - __init__(client: RedditClient)

  2. 수집 메서드:
     - get_post_comments(post_id: str, limit: int | None = None) -> list[Comment]
       - limit=None이면 모든 댓글 수집
       - replace_more() 호출로 "more comments" 확장

     - get_subreddit_comments(subreddit: str, limit: int = 100) -> list[Comment]
       - 서브레딧의 최근 댓글 스트림

  3. 유틸리티:
     - _convert_comment(comment) -> Comment: PRAW comment를 Comment 모델로 변환
     - _flatten_comment_tree(comments) -> list[Comment]: 댓글 트리를 평탄화

  주의:
  - 댓글 수집은 API 호출이 많으므로 limit 파라미터 중요
  - replace_more(limit=0)으로 추가 로딩 제한 가능
  </action>
  <verify>
  - python -c "import sys; sys.path.insert(0, 'src'); from reddit_insight.reddit.collectors import CommentCollector; print('CommentCollector OK')"
  </verify>
  <done>
  - CommentCollector가 게시물별/서브레딧별 댓글 수집 가능
  - 댓글 트리 평탄화 지원
  </done>
</task>

<task type="auto">
  <name>Task 3: RedditClient에 수집기 통합</name>
  <files>src/reddit_insight/reddit/client.py, src/reddit_insight/reddit/__init__.py</files>
  <action>
  1. client.py의 RedditClient 확장:
     - posts 프로퍼티: PostCollector 인스턴스 반환 (lazy init)
     - comments 프로퍼티: CommentCollector 인스턴스 반환 (lazy init)

  2. 편의 메서드 추가:
     - get_hot_posts(subreddit: str, limit: int = 100) -> list[Post]
     - get_post_comments(post_id: str, limit: int | None = None) -> list[Comment]

  3. __init__.py 업데이트:
     - PostCollector, CommentCollector export 추가
     - __all__ 업데이트
  </action>
  <verify>
  - python -c "import sys; sys.path.insert(0, 'src'); from reddit_insight.reddit import RedditClient, PostCollector, CommentCollector; print('All exports OK')"
  </verify>
  <done>
  - RedditClient.posts와 .comments로 수집기 접근 가능
  - 편의 메서드로 간단한 수집 가능
  </done>
</task>

<task type="auto">
  <name>Task 4: 수집기 테스트 작성</name>
  <files>tests/test_collectors.py</files>
  <action>
  tests/test_collectors.py 생성:

  1. MockPRAW fixture:
     - PRAW 호출을 모킹하는 fixture

  2. TestPostCollector:
     - test_get_hot_returns_posts
     - test_search_with_query
     - test_convert_submission

  3. TestCommentCollector:
     - test_get_post_comments
     - test_flatten_comment_tree
     - test_convert_comment

  주의:
  - 실제 API 호출 없이 모킹으로 테스트
  - 모델 변환 로직 중점 테스트
  </action>
  <verify>
  - python -m pytest tests/test_collectors.py -v --collect-only 2>/dev/null || echo "Tests defined"
  </verify>
  <done>
  - 수집기 단위 테스트 작성됨
  - 모킹으로 API 의존성 제거
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] PostCollector가 hot/new/top/rising/search 지원
- [ ] CommentCollector가 게시물/서브레딧 댓글 수집 지원
- [ ] RedditClient에서 수집기 접근 가능
- [ ] 기본 테스트 작성됨
</verification>

<success_criteria>

- 모든 태스크 완료
- 수집기가 PRAW 객체를 Pydantic 모델로 변환
- 테스트 파일 존재 (실행은 CI에서)

</success_criteria>

<output>
After completion, create `.planning/phases/02-reddit-api/02-02-SUMMARY.md`
</output>
