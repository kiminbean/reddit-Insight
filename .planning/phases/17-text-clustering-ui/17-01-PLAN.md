# Plan 17-01: Text Clustering UI

## Objective

TextClusterer ML 모듈의 클러스터링 결과를 대시보드에 시각화한다. 클러스터별 키워드, 대표 문서, 클러스터 분포를 표시한다.

## Execution Context

```
src/reddit_insight/analysis/ml/
├── text_clusterer.py       # TextClusterer (K-means/Agglomerative)
└── models.py               # ClusterResult, Cluster

src/reddit_insight/dashboard/
├── routers/
├── templates/
```

## Context

### TextClusterer API

```python
from reddit_insight.analysis.ml import TextClusterer, TextClustererConfig

clusterer = TextClusterer(TextClustererConfig(
    n_clusters="auto",  # 자동 최적 클러스터 수 선택
    method="kmeans",    # kmeans 또는 agglomerative
    max_clusters=10
))

result = clusterer.fit_transform(documents)
# result.clusters: list[Cluster]
#   - cluster_id: int
#   - size: int
#   - keywords: list[str]  # 클러스터 대표 키워드
#   - representative_docs: list[int]  # 대표 문서 인덱스
# result.labels: list[int]  # 각 문서의 클러스터 라벨
# result.silhouette_score: float
# result.n_clusters: int
```

### 구현 목표

1. 게시물/댓글을 유사도 기반으로 클러스터링
2. 클러스터별 대표 키워드 및 문서 표시
3. 클러스터 크기 분포 시각화

## Tasks

### Task 1: ClusterService 생성

**목표**: TextClusterer를 래핑하여 대시보드용 데이터 제공

**파일**: `src/reddit_insight/dashboard/services/cluster_service.py`

**구현**:
```python
class ClusterService:
    def __init__(self):
        self._clusterer = TextClusterer(TextClustererConfig())
        self._cached_result: ClusterResult | None = None
        self._documents: list[str] = []

    def cluster_documents(
        self, documents: list[str], n_clusters: int | str = "auto"
    ) -> dict:
        """문서를 클러스터링한다."""
        self._documents = documents
        result = self._clusterer.fit_transform(documents)
        self._cached_result = result
        return {
            "n_clusters": result.n_clusters,
            "silhouette_score": result.silhouette_score,
            "clusters": [
                {
                    "id": c.cluster_id,
                    "size": c.size,
                    "keywords": c.keywords[:5],
                    "sample_docs": [documents[i][:100] for i in c.representative_docs[:3]],
                }
                for c in result.clusters
            ],
        }

    def assign_document(self, document: str) -> int:
        """새 문서를 클러스터에 할당한다."""
```

### Task 2: Clusters 라우터 생성

**목표**: 클러스터링 페이지 및 API

**파일**: `src/reddit_insight/dashboard/routers/clusters.py`

**구현**:
```python
router = APIRouter(prefix="/dashboard/clusters", tags=["clusters"])

@router.get("/", response_class=HTMLResponse)
async def clusters_home(request: Request) -> HTMLResponse:
    """클러스터링 메인 페이지."""

@router.get("/analyze", response_class=JSONResponse)
async def analyze_clusters(
    n_clusters: int | str = Query(default="auto")
) -> JSONResponse:
    """클러스터링을 실행하고 결과를 반환한다."""

@router.get("/cluster/{cluster_id}", response_class=HTMLResponse)
async def cluster_detail(request: Request, cluster_id: int) -> HTMLResponse:
    """특정 클러스터의 상세 정보."""
```

### Task 3: Clusters 페이지 템플릿 생성

**목표**: 클러스터링 결과를 시각화하는 페이지

**파일**: `src/reddit_insight/dashboard/templates/clusters/index.html`

**구현**:
- 클러스터 수 입력 (숫자 또는 "auto")
- "분석 실행" 버튼
- 클러스터 카드 그리드 (각 클러스터별):
  - 대표 키워드 태그
  - 문서 수
  - 샘플 문서 미리보기
- 클러스터 크기 분포 바 차트 (Chart.js)
- Silhouette Score 표시

### Task 4: 클러스터 상세 페이지 생성

**목표**: 특정 클러스터의 모든 문서를 볼 수 있는 페이지

**파일**: `src/reddit_insight/dashboard/templates/clusters/detail.html`

**구현**:
- 클러스터 ID 및 키워드
- 해당 클러스터의 모든 문서 목록 (페이지네이션)
- 다른 클러스터로 이동 링크

### Task 5: 내비게이션에 Clusters 메뉴 추가

**목표**: 대시보드 네비게이션에 Clusters 링크 추가

**파일**: `src/reddit_insight/dashboard/templates/base.html`

**구현**:
- 사이드바에 "Clusters" 메뉴 항목 추가

## Verification

```bash
# 1. 서비스 테스트
pytest tests/dashboard/test_cluster_service.py -v

# 2. API 테스트
curl http://localhost:8888/dashboard/clusters/analyze?n_clusters=auto

# 3. UI 확인
# 브라우저에서 /dashboard/clusters 접속
# "분석 실행" 클릭 후 클러스터 카드 및 차트 확인
```

## Success Criteria

- [ ] ClusterService가 TextClusterer 호출 성공
- [ ] `/dashboard/clusters` 페이지 렌더링
- [ ] 클러스터별 키워드 및 샘플 문서 표시
- [ ] 클러스터 크기 분포 차트 표시
- [ ] 클러스터 상세 페이지 동작

## Output

- `src/reddit_insight/dashboard/services/cluster_service.py` 생성
- `src/reddit_insight/dashboard/routers/clusters.py` 생성
- `src/reddit_insight/dashboard/templates/clusters/index.html` 생성
- `src/reddit_insight/dashboard/templates/clusters/detail.html` 생성
- `src/reddit_insight/dashboard/templates/base.html` 수정
- `src/reddit_insight/dashboard/app.py` 수정 (라우터 등록)
- `tests/dashboard/test_cluster_service.py` 생성
- 17-01-SUMMARY.md 작성
