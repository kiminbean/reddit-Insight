---
phase: 11-advanced-analytics
plan: 02
type: execute
depends_on: [11-01]
---

<objective>
시계열 예측 엔진 구현 - 키워드 트렌드의 미래 값 예측.

Purpose: 기존 TrendCalculator의 과거 분석을 확장하여 미래 트렌드 예측 기능 추가
Output: TrendPredictor 클래스, 예측 결과 시각화 지원
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/11-advanced-analytics/11-01-SUMMARY.md
@src/reddit_insight/analysis/trends.py
@src/reddit_insight/analysis/time_series.py
@src/reddit_insight/analysis/ml/base.py
@src/reddit_insight/analysis/ml/models.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: TrendPredictor 클래스 구현</name>
  <files>src/reddit_insight/analysis/ml/trend_predictor.py</files>
  <action>
  statsmodels 기반 시계열 예측기 구현:

  1. TrendPredictorConfig (dataclass):
     - forecast_periods: int = 7 (예측할 기간 수)
     - confidence_level: float = 0.95 (신뢰구간)
     - min_data_points: int = 10 (최소 데이터 포인트)
     - model_type: Literal["auto", "ets", "arima"] = "auto"
     - seasonal_period: int | None = None (계절성 주기)

  2. TrendPredictor(MLAnalyzerBase) 클래스:
     - __init__(config: TrendPredictorConfig)

     - predict(time_series: TimeSeries) -> PredictionResult:
       1. 데이터 검증 (최소 포인트 확인)
       2. 모델 선택 (auto: 데이터 특성에 따라 자동 선택)
          - 데이터 10-30개: Simple Exponential Smoothing
          - 데이터 30개 이상 + 계절성: Holt-Winters
          - 데이터 30개 이상 + 추세: Holt's Linear
       3. 모델 피팅 및 예측
       4. 신뢰구간 계산
       5. PredictionResult 반환

     - _fit_ets(values) -> 지수평활법 모델
     - _fit_arima(values) -> ARIMA 모델 (order 자동 선택)
     - _calculate_metrics(actual, predicted) -> dict (MAE, RMSE, MAPE)

  statsmodels.tsa 사용:
  - from statsmodels.tsa.holtwinters import ExponentialSmoothing
  - from statsmodels.tsa.arima.model import ARIMA
  - from statsmodels.tsa.stattools import adfuller (정상성 검정)

  기존 TimeSeries 클래스와 호환되도록 구현.
  </action>
  <verify>
  python -c "
from reddit_insight.analysis.ml.trend_predictor import TrendPredictor, TrendPredictorConfig
from reddit_insight.analysis.time_series import TimeSeries, TimePoint
from datetime import datetime, timedelta

# 테스트 데이터 생성
points = [TimePoint(datetime.now() - timedelta(days=i), 100 + i*2 + (i%7)*5) for i in range(30, 0, -1)]
ts = TimeSeries(points=points)

# 예측 실행
predictor = TrendPredictor(TrendPredictorConfig(forecast_periods=7))
result = predictor.predict(ts)
print(f'Predicted {len(result.values)} points, confidence: {result.confidence_level}')
"
  </verify>
  <done>TrendPredictor가 7일 예측 생성, 신뢰구간 포함</done>
</task>

<task type="auto">
  <name>Task 2: KeywordTrendAnalyzer 통합</name>
  <files>src/reddit_insight/analysis/trends.py</files>
  <action>
  기존 KeywordTrendAnalyzer에 예측 기능 통합:

  1. KeywordTrendAnalyzer 클래스 확장:
     - predictor: TrendPredictor | None = None (지연 초기화)

     - analyze_with_forecast(posts, keywords, forecast_periods=7) -> list[KeywordTrendResult]:
       기존 analyze() 결과에 예측 정보 추가

  2. KeywordTrendResult 확장 (기존 필드 유지):
     - forecast: PredictionResult | None = None (새 필드)

  3. 통합 워크플로우:
     - analyze()로 과거 트렌드 분석
     - 각 키워드의 TimeSeries에 대해 predict() 호출
     - forecast 필드에 예측 결과 추가

  기존 analyze() 메서드는 변경하지 않음 (하위 호환성).
  새 메서드 analyze_with_forecast()로 예측 기능 제공.
  </action>
  <verify>
  python -c "
from reddit_insight.analysis.trends import KeywordTrendAnalyzer
from datetime import datetime

# Mock posts
class MockPost:
    def __init__(self, text, created):
        self.title = text
        self.selftext = ''
        self.created_utc = created

import random
posts = [MockPost(f'python learning tips {i}', datetime.now().timestamp() - i*86400 + random.randint(0, 3600))
         for i in range(60)]

analyzer = KeywordTrendAnalyzer()
results = analyzer.analyze_with_forecast(posts, ['python'], forecast_periods=7)
print(f'Keyword: {results[0].keyword}, Has forecast: {results[0].forecast is not None}')
"
  </verify>
  <done>analyze_with_forecast()가 예측 포함된 KeywordTrendResult 반환</done>
</task>

<task type="auto">
  <name>Task 3: 예측 엔진 테스트</name>
  <files>tests/analysis/ml/test_trend_predictor.py</files>
  <action>
  TrendPredictor 유닛 테스트 작성:

  1. test_predict_with_sufficient_data:
     - 30개 이상 데이터로 예측 성공 확인
     - 예측 기간 수 확인
     - 신뢰구간 존재 확인

  2. test_predict_with_minimal_data:
     - 10-30개 데이터로 Simple ES 사용 확인

  3. test_predict_insufficient_data:
     - 10개 미만 데이터로 ValueError 발생 확인

  4. test_prediction_result_structure:
     - PredictionResult 필드 검증
     - timestamps, values, lower/upper_bound 길이 동일 확인

  5. test_metrics_calculation:
     - MAE, RMSE, MAPE 메트릭 존재 확인

  pytest fixtures 사용하여 테스트 데이터 생성.
  </action>
  <verify>
  cd /Users/ibkim/Projects/reddit-Insight && source .venv/bin/activate && pytest tests/analysis/ml/test_trend_predictor.py -v
  </verify>
  <done>모든 예측기 테스트 통과</done>
</task>
</tasks>

<verification>
완료 전 확인사항:
- [ ] TrendPredictor 클래스 동작 확인
- [ ] KeywordTrendAnalyzer.analyze_with_forecast() 동작 확인
- [ ] 신뢰구간이 예측값과 함께 반환됨
- [ ] 기존 테스트 유지: pytest tests/analysis/test_trends.py -v
- [ ] 새 테스트 통과: pytest tests/analysis/ml/test_trend_predictor.py -v
</verification>

<success_criteria>
- TrendPredictor가 ETS/ARIMA 자동 선택으로 예측 수행
- 신뢰구간(95%) 포함된 예측 결과 반환
- KeywordTrendAnalyzer에 예측 기능 통합
- 기존 API 하위 호환성 유지
</success_criteria>

<output>
완료 후 .planning/phases/11-advanced-analytics/11-02-SUMMARY.md 생성:

# Plan 11-02: Trend Prediction Engine Summary

**시계열 예측 엔진 구현 완료**

## Accomplishments
- TrendPredictor 클래스 (ETS/ARIMA 자동 선택)
- KeywordTrendAnalyzer 예측 기능 통합
- 예측 결과 데이터 모델

## Files Created/Modified
- src/reddit_insight/analysis/ml/trend_predictor.py (생성)
- src/reddit_insight/analysis/trends.py (수정)
- tests/analysis/ml/test_trend_predictor.py (생성)

## Decisions Made
- 모델 자동 선택 로직

## Next Phase Readiness
- 11-03 (이상 탐지) 진행 가능
</output>
