---
phase: 11-advanced-analytics
plan: 04
type: execute
depends_on: [11-01]
---

<objective>
토픽 모델링 및 클러스터링 엔진 구현 - 텍스트 테마 발견 및 유사 콘텐츠 그룹화.

Purpose: Reddit 포스트를 주제별로 자동 분류하고 유사한 수요/불만을 그룹화
Output: TopicModeler, TextClusterer 클래스, 대시보드 통합 지원
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/11-advanced-analytics/11-01-SUMMARY.md
@src/reddit_insight/analysis/keywords.py
@src/reddit_insight/analysis/tfidf.py
@src/reddit_insight/analysis/ml/base.py
@src/reddit_insight/analysis/ml/models.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: TopicModeler 클래스 구현</name>
  <files>src/reddit_insight/analysis/ml/topic_modeler.py</files>
  <action>
  LDA/NMF 기반 토픽 모델러 구현:

  1. TopicModelerConfig (dataclass):
     - n_topics: int = 5 (토픽 수)
     - method: Literal["lda", "nmf", "auto"] = "auto"
     - max_features: int = 1000 (TF-IDF 피처 수)
     - min_df: int = 2 (최소 문서 빈도)
     - max_df: float = 0.95 (최대 문서 빈도)
     - n_top_words: int = 10 (토픽당 상위 단어 수)

  2. TopicModeler(MLAnalyzerBase) 클래스:
     - __init__(config: TopicModelerConfig)
     - _vectorizer: TfidfVectorizer (지연 초기화)
     - _model: LatentDirichletAllocation | NMF (지연 초기화)

     - fit_transform(texts: list[str]) -> TopicResult:
       1. TF-IDF 벡터화 (기존 TfidfAnalyzer 활용 가능)
       2. LDA 또는 NMF 모델 피팅
       3. 토픽별 상위 단어 추출
       4. 문서-토픽 분포 계산
       5. coherence score 계산 (단순화: 토픽 내 단어 공출현 빈도)
       6. TopicResult 반환

     - get_document_topics(text: str) -> list[tuple[int, float]]:
       단일 문서의 토픽 분포 반환

     - _extract_topic_words(model, feature_names) -> list[Topic]:
       각 토픽의 상위 단어 추출

     - _auto_select_method(n_documents) -> str:
       - 문서 <100개: nmf (더 빠름)
       - 문서 >=100개: lda (더 정확)

  sklearn 사용:
  - from sklearn.feature_extraction.text import TfidfVectorizer
  - from sklearn.decomposition import LatentDirichletAllocation, NMF

  기존 RedditTokenizer 재사용하여 토큰화 일관성 유지.
  </action>
  <verify>
  python -c "
from reddit_insight.analysis.ml.topic_modeler import TopicModeler, TopicModelerConfig

texts = [
    'I need a tool for managing tasks and projects',
    'Looking for project management software',
    'How to organize my work better',
    'Best apps for productivity and focus',
    'Need help with concentration and time management',
    'Frustrated with slow loading times',
    'The app crashes frequently on my phone',
    'Performance issues with the latest update',
]

modeler = TopicModeler(TopicModelerConfig(n_topics=2))
result = modeler.fit_transform(texts)
print(f'Found {result.n_topics} topics')
for topic in result.topics:
    print(f'  Topic {topic.id}: {topic.keywords[:3]}')
"
  </verify>
  <done>TopicModeler가 2개 토픽 발견, 각 토픽에 관련 키워드 포함</done>
</task>

<task type="auto">
  <name>Task 2: TextClusterer 클래스 구현</name>
  <files>src/reddit_insight/analysis/ml/text_clusterer.py</files>
  <action>
  텍스트 클러스터링 엔진 구현:

  1. TextClustererConfig (dataclass):
     - n_clusters: int | None = None (None이면 자동 결정)
     - method: Literal["kmeans", "agglomerative", "auto"] = "auto"
     - max_features: int = 500
     - min_cluster_size: int = 2
     - max_clusters: int = 10 (자동 결정 시 최대값)

  2. TextClusterer(MLAnalyzerBase) 클래스:
     - __init__(config: TextClustererConfig)

     - cluster(texts: list[str]) -> ClusterResult:
       1. TF-IDF 벡터화
       2. 클러스터 수 자동 결정 (silhouette score 기반)
       3. K-means 또는 Agglomerative 클러스터링
       4. 각 클러스터의 centroid 키워드 추출
       5. 클러스터 라벨링 (상위 키워드 조합)
       6. ClusterResult 반환

     - _find_optimal_k(X, max_k) -> int:
       silhouette score가 가장 높은 k 선택 (elbow method 대안)

     - _extract_cluster_keywords(X, labels, feature_names) -> dict:
       각 클러스터의 centroid에서 상위 키워드 추출

     - assign_cluster(text: str) -> int:
       새 텍스트를 기존 클러스터에 할당

  sklearn 사용:
  - from sklearn.cluster import KMeans, AgglomerativeClustering
  - from sklearn.metrics import silhouette_score
  </action>
  <verify>
  python -c "
from reddit_insight.analysis.ml.text_clusterer import TextClusterer, TextClustererConfig

texts = [
    'I need a better way to manage my tasks',
    'Looking for task management tool',
    'How to organize daily tasks',
    'The app is too slow and crashes',
    'Performance is terrible after update',
    'Constant bugs and errors',
]

clusterer = TextClusterer(TextClustererConfig(n_clusters=2))
result = clusterer.cluster(texts)
print(f'Created {result.n_clusters} clusters, silhouette: {result.silhouette_score:.2f}')
for cluster in result.clusters:
    print(f'  Cluster {cluster.id}: {cluster.size} items, keywords: {cluster.keywords[:3]}')
"
  </verify>
  <done>TextClusterer가 2개 클러스터 생성, 키워드 레이블 포함</done>
</task>

<task type="auto">
  <name>Task 3: 토픽/클러스터링 테스트 및 __init__ 업데이트</name>
  <files>tests/analysis/ml/test_topic_clusterer.py, src/reddit_insight/analysis/ml/__init__.py</files>
  <action>
  1. 테스트 파일 작성 (test_topic_clusterer.py):

     - test_topic_modeler_lda:
       LDA 방법으로 토픽 추출 확인

     - test_topic_modeler_nmf:
       NMF 방법으로 토픽 추출 확인

     - test_topic_result_structure:
       TopicResult 필드 검증, topics 리스트에 Topic 포함

     - test_text_clusterer_kmeans:
       K-means로 클러스터링 확인

     - test_auto_cluster_selection:
       자동 클러스터 수 선택 확인

     - test_cluster_result_structure:
       ClusterResult 필드 검증

     - test_empty_input_handling:
       빈 입력에 대한 예외 처리 확인

  2. __init__.py 업데이트:
     모든 ML 분석기 export:
     - MLAnalyzerBase, AnalysisResult
     - PredictionResult, AnomalyResult, ClusterResult, TopicResult
     - TrendPredictor, TrendPredictorConfig
     - AnomalyDetector, AnomalyDetectorConfig
     - TopicModeler, TopicModelerConfig
     - TextClusterer, TextClustererConfig
  </action>
  <verify>
  cd /Users/ibkim/Projects/reddit-Insight && source .venv/bin/activate && pytest tests/analysis/ml/ -v && python -c "from reddit_insight.analysis.ml import TopicModeler, TextClusterer, TrendPredictor, AnomalyDetector; print('All imports OK')"
  </verify>
  <done>모든 ML 모듈 테스트 통과, 통합 임포트 성공</done>
</task>
</tasks>

<verification>
완료 전 확인사항:
- [ ] TopicModeler LDA/NMF 모두 동작 확인
- [ ] TextClusterer 자동 클러스터 수 결정 확인
- [ ] silhouette score 계산 확인
- [ ] 클러스터 키워드 레이블링 확인
- [ ] 전체 ML 모듈 테스트: pytest tests/analysis/ml/ -v
- [ ] 기존 테스트 영향 없음: pytest tests/ -v --ignore=tests/analysis/ml/
</verification>

<success_criteria>
- TopicModeler가 LDA/NMF로 토픽 추출
- TextClusterer가 유사 텍스트 그룹화
- 자동 클러스터 수 결정 (silhouette 기반)
- 클러스터/토픽에 의미있는 키워드 레이블
- 모든 ML 분석기 통합 export
</success_criteria>

<output>
완료 후 .planning/phases/11-advanced-analytics/11-04-SUMMARY.md 생성:

# Plan 11-04: Topic Modeling & Clustering Summary

**토픽 모델링 및 클러스터링 엔진 구현 완료**

## Accomplishments
- TopicModeler 클래스 (LDA/NMF)
- TextClusterer 클래스 (K-means, 자동 k 선택)
- 클러스터 키워드 레이블링
- ML 모듈 통합 export

## Files Created/Modified
- src/reddit_insight/analysis/ml/topic_modeler.py (생성)
- src/reddit_insight/analysis/ml/text_clusterer.py (생성)
- src/reddit_insight/analysis/ml/__init__.py (수정)
- tests/analysis/ml/test_topic_clusterer.py (생성)

## Decisions Made
- 토픽/클러스터 수 자동 결정 로직

## Next Phase Readiness
- Phase 11 완료, 대시보드 통합 가능
</output>
