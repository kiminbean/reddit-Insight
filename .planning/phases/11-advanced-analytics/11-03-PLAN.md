---
phase: 11-advanced-analytics
plan: 03
type: execute
depends_on: [11-01]
---

<objective>
이상 탐지 엔진 구현 - 키워드 트렌드의 비정상적 변화 감지.

Purpose: 급격한 언급 증가/감소, 비정상적 패턴을 자동 탐지하여 주목할 신호 발견
Output: AnomalyDetector 클래스, 이상 포인트 시각화 지원
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/11-advanced-analytics/11-01-SUMMARY.md
@src/reddit_insight/analysis/rising.py
@src/reddit_insight/analysis/ml/base.py
@src/reddit_insight/analysis/ml/models.py
</context>

<tasks>
<task type="auto">
  <name>Task 1: AnomalyDetector 클래스 구현</name>
  <files>src/reddit_insight/analysis/ml/anomaly_detector.py</files>
  <action>
  다중 방법 기반 이상 탐지기 구현:

  1. AnomalyDetectorConfig (dataclass):
     - method: Literal["zscore", "iqr", "isolation_forest", "auto"] = "auto"
     - threshold: float = 3.0 (z-score용) 또는 contamination (IF용)
     - window_size: int = 7 (이동 윈도우 크기)
     - min_data_points: int = 10

  2. AnomalyDetector(MLAnalyzerBase) 클래스:
     - __init__(config: AnomalyDetectorConfig)

     - detect(time_series: TimeSeries) -> AnomalyResult:
       1. 데이터 검증
       2. 방법에 따른 탐지 실행
       3. AnomalyResult 반환

     - _detect_zscore(values) -> list[AnomalyPoint]:
       - 이동 평균 및 표준편차 계산
       - z-score가 threshold 초과하면 이상 판정
       - anomaly_score = abs(z-score)

     - _detect_iqr(values) -> list[AnomalyPoint]:
       - Q1, Q3, IQR 계산
       - IQR * 1.5 범위 밖이면 이상 판정

     - _detect_isolation_forest(values) -> list[AnomalyPoint]:
       - sklearn.ensemble.IsolationForest 사용
       - contamination 파라미터로 이상치 비율 조절
       - anomaly_score = -1 * decision_function

     - _auto_select_method(values) -> str:
       데이터 특성에 따라 최적 방법 선택:
       - 데이터 <30개: zscore (단순하고 안정적)
       - 데이터 30-100개: iqr
       - 데이터 >100개: isolation_forest

  3. AnomalyPoint 확장 (models.py에서):
     - description: str (이상 설명, 예: "급격한 증가 감지")
  </action>
  <verify>
  python -c "
from reddit_insight.analysis.ml.anomaly_detector import AnomalyDetector, AnomalyDetectorConfig
from reddit_insight.analysis.time_series import TimeSeries, TimePoint
from datetime import datetime, timedelta
import random

# 이상치 포함 데이터 생성
points = []
for i in range(30, 0, -1):
    val = 100 + random.randint(-10, 10)
    if i == 15:  # 이상치 삽입
        val = 300
    points.append(TimePoint(datetime.now() - timedelta(days=i), val))

ts = TimeSeries(points=points)
detector = AnomalyDetector(AnomalyDetectorConfig())
result = detector.detect(ts)
print(f'Anomalies found: {result.anomaly_count}/{result.total_points}')
"
  </verify>
  <done>AnomalyDetector가 이상치 탐지, anomaly_count > 0</done>
</task>

<task type="auto">
  <name>Task 2: Rising 키워드 분석 통합</name>
  <files>src/reddit_insight/analysis/rising.py</files>
  <action>
  기존 RisingKeywordDetector에 이상 탐지 기능 통합:

  1. RisingKeywordDetector 클래스 확장:
     - anomaly_detector: AnomalyDetector | None = None (지연 초기화)

     - detect_with_anomalies(keywords_over_time) -> list[RisingKeyword]:
       기존 detect() 결과에 이상 탐지 정보 추가

  2. RisingKeyword 확장 (기존 필드 유지):
     - anomalies: list[AnomalyPoint] | None = None (새 필드)
     - has_anomaly: bool = False (편의 필드)

  3. 통합 워크플로우:
     - detect()로 급상승 키워드 탐지
     - 각 키워드의 시계열에 대해 anomaly_detector.detect() 호출
     - 이상이 발견되면 RisingKeyword.anomalies에 저장

  기존 detect() 메서드는 변경하지 않음 (하위 호환성).
  </action>
  <verify>
  python -c "
from reddit_insight.analysis.rising import RisingKeywordDetector

# 테스트 데이터 (시간별 키워드 카운트)
keywords_over_time = {
    'python': [10, 12, 11, 13, 50, 14, 12, 11, 13, 10],  # 이상치 포함
    'javascript': [5, 6, 5, 6, 5, 6, 5, 6, 5, 6],  # 정상
}

detector = RisingKeywordDetector()
results = detector.detect_with_anomalies(keywords_over_time)
python_result = next((r for r in results if r.keyword == 'python'), None)
if python_result:
    print(f'python has_anomaly: {python_result.has_anomaly}')
"
  </verify>
  <done>detect_with_anomalies()가 이상 정보 포함된 RisingKeyword 반환</done>
</task>

<task type="auto">
  <name>Task 3: 이상 탐지 테스트</name>
  <files>tests/analysis/ml/test_anomaly_detector.py</files>
  <action>
  AnomalyDetector 유닛 테스트 작성:

  1. test_detect_zscore:
     - z-score 방법으로 명확한 이상치 탐지 확인

  2. test_detect_iqr:
     - IQR 방법으로 이상치 탐지 확인

  3. test_detect_isolation_forest:
     - Isolation Forest로 이상치 탐지 확인

  4. test_auto_method_selection:
     - 데이터 크기에 따른 자동 방법 선택 확인

  5. test_no_anomalies_in_normal_data:
     - 정상 데이터에서 이상치 없음 확인

  6. test_anomaly_result_structure:
     - AnomalyResult 필드 검증
     - anomalies 리스트에 AnomalyPoint 포함 확인

  테스트 데이터: 명확한 이상치(평균의 3배 이상)와 정상 데이터 혼합.
  </action>
  <verify>
  cd /Users/ibkim/Projects/reddit-Insight && source .venv/bin/activate && pytest tests/analysis/ml/test_anomaly_detector.py -v
  </verify>
  <done>모든 이상 탐지 테스트 통과</done>
</task>
</tasks>

<verification>
완료 전 확인사항:
- [ ] AnomalyDetector 3가지 방법 모두 동작 확인
- [ ] 자동 방법 선택 로직 확인
- [ ] RisingKeywordDetector.detect_with_anomalies() 동작 확인
- [ ] 기존 테스트 유지: pytest tests/analysis/test_rising.py -v
- [ ] 새 테스트 통과: pytest tests/analysis/ml/test_anomaly_detector.py -v
</verification>

<success_criteria>
- AnomalyDetector가 z-score/IQR/Isolation Forest 지원
- 자동 방법 선택으로 데이터 특성에 맞는 탐지
- RisingKeywordDetector에 이상 탐지 통합
- 명확한 이상치(3sigma 이상)를 정확히 탐지
</success_criteria>

<output>
완료 후 .planning/phases/11-advanced-analytics/11-03-SUMMARY.md 생성:

# Plan 11-03: Anomaly Detection Summary

**이상 탐지 엔진 구현 완료**

## Accomplishments
- AnomalyDetector 클래스 (z-score, IQR, Isolation Forest)
- RisingKeywordDetector 이상 탐지 통합
- 자동 방법 선택 로직

## Files Created/Modified
- src/reddit_insight/analysis/ml/anomaly_detector.py (생성)
- src/reddit_insight/analysis/rising.py (수정)
- tests/analysis/ml/test_anomaly_detector.py (생성)

## Decisions Made
- 방법별 임계값 설정

## Next Phase Readiness
- 11-04 (토픽 모델링) 진행 가능
</output>
