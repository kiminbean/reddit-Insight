# Plan 15-01: Anomaly Detection UI

## Objective

AnomalyDetector ML 모듈의 이상 탐지 결과를 대시보드에 시각화한다. 이상 포인트를 차트에서 하이라이트하고 상세 정보를 제공한다.

## Execution Context

```
src/reddit_insight/analysis/ml/
├── anomaly_detector.py     # AnomalyDetector (z-score, IQR, Isolation Forest)
└── models.py               # AnomalyResult, AnomalyPoint

src/reddit_insight/dashboard/
├── routers/trends.py
├── templates/trends/
```

## Context

### AnomalyDetector API

```python
from reddit_insight.analysis.ml import AnomalyDetector, AnomalyDetectorConfig

detector = AnomalyDetector(AnomalyDetectorConfig(
    method="auto",  # z_score, iqr, isolation_forest 자동 선택
    threshold=3.0,
    contamination=0.1
))

result = detector.detect(time_series_data)
# result.anomalies: list[AnomalyPoint]
#   - index: int
#   - value: float
#   - score: float (이상 점수)
#   - method: str
# result.is_anomaly: list[bool]  # 각 포인트의 이상 여부
# result.anomaly_count: int
```

### 구현 목표

1. 키워드 시계열에서 이상 포인트 탐지
2. 차트에서 이상 포인트를 빨간 점으로 하이라이트
3. 이상 탐지 요약 정보 표시

## Tasks

### Task 1: AnomalyService 생성

**목표**: AnomalyDetector를 래핑하여 대시보드용 데이터 제공

**파일**: `src/reddit_insight/dashboard/services/anomaly_service.py`

**구현**:
```python
class AnomalyService:
    def __init__(self):
        self._detector = AnomalyDetector(AnomalyDetectorConfig())

    def detect_anomalies(
        self, keyword: str, time_series: list[float], dates: list[str]
    ) -> dict:
        """시계열에서 이상 포인트를 탐지한다."""
        result = self._detector.detect(time_series)
        return {
            "keyword": keyword,
            "anomaly_count": result.anomaly_count,
            "anomalies": [
                {
                    "date": dates[a.index],
                    "value": a.value,
                    "score": a.score,
                    "method": a.method,
                }
                for a in result.anomalies
            ],
            "is_anomaly": result.is_anomaly,
        }
```

### Task 2: 이상 탐지 API 엔드포인트 추가

**목표**: 키워드 이상 탐지 결과를 JSON으로 반환

**파일**: `src/reddit_insight/dashboard/routers/trends.py`

**구현**:
```python
@router.get("/anomalies/{keyword}", response_class=JSONResponse)
async def detect_anomalies(
    keyword: str,
    days: int = Query(default=30, ge=7, le=90),
    service: TrendService = Depends(get_trend_service),
) -> JSONResponse:
    """키워드의 이상 포인트를 탐지하여 반환한다."""
```

### Task 3: 이상 탐지 차트 컴포넌트 생성

**목표**: 이상 포인트를 하이라이트하는 차트

**파일**: `src/reddit_insight/dashboard/templates/trends/partials/anomaly_chart.html`

**구현**:
- 정상 데이터: 파란 선
- 이상 포인트: 빨간 점 (pointRadius 증가)
- 호버 시 이상 점수 표시
- 이상 탐지 방법 및 개수 표시

### Task 4: Trends 페이지에 이상 탐지 섹션 추가

**목표**: 키워드 선택 시 이상 탐지 결과 표시

**파일**: `src/reddit_insight/dashboard/templates/trends/index.html`

**구현**:
- 예측 차트 아래에 이상 탐지 섹션 추가
- 탭 또는 토글로 예측/이상탐지 전환

## Verification

```bash
# 1. 서비스 테스트
pytest tests/dashboard/test_anomaly_service.py -v

# 2. API 테스트
curl http://localhost:8888/dashboard/trends/anomalies/claude?days=30

# 3. UI 확인
# 브라우저에서 트렌드 페이지 → 키워드 클릭 → 이상 탐지 차트 확인
```

## Success Criteria

- [ ] AnomalyService가 AnomalyDetector 호출 성공
- [ ] `/dashboard/trends/anomalies/{keyword}` API 동작
- [ ] 차트에서 이상 포인트가 빨간 점으로 표시
- [ ] 이상 탐지 요약 (개수, 방법) 표시

## Output

- `src/reddit_insight/dashboard/services/anomaly_service.py` 생성
- `src/reddit_insight/dashboard/routers/trends.py` 수정
- `src/reddit_insight/dashboard/templates/trends/partials/anomaly_chart.html` 생성
- `src/reddit_insight/dashboard/templates/trends/index.html` 수정
- `tests/dashboard/test_anomaly_service.py` 생성
- 15-01-SUMMARY.md 작성
